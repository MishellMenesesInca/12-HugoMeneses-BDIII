CREATE TABLESPACE TBSLABORATORIO
DATAFILE 'tbslaboratorio.dbf'
size 200M;

alter session set "_ORACLE_SCRIPT"=true;

--Crear Usuario (esquema BD para proyectos)
CREATE USER USER_ORACLE IDENTIFIED BY OracleAcademy
DEFAULT TABLESPACE TBSLABORATORIO
TEMPORARY TABLESPACE TEMP
QUOTA UNLIMITED ON TBSLABORATORIO;

--Habilitar privilegios de usuario para la creación de objetos
GRANT CREATE SESSION TO USER_ORACLE;
GRANT CREATE TABLE TO USER_ORACLE;
GRANT CREATE VIEW TO USER_ORACLE;
GRANT CREATE PROCEDURE TO USER_ORACLE;
GRANT CREATE TRIGGER TO USER_ORACLE;
GRANT CREATE SEQUENCE TO USER_ORACLE;
GRANT CREATE JOB TO USER_ORACLE;


CREATE TABLE PERSONA (
    IDPER integer  NOT NULL,
    DNIPER char(8)  NOT NULL,
    NOMPER varchar2(50)  NOT NULL,
    APEPER varchar2(50)  NOT NULL,
    EMAPER varchar2(80)  NOT NULL,
    CELPER char(9)  NOT NULL,
    TIPPER char(1) NOT NULL,
    ESTPER char(1) Default 'A' NOT NULL,
    FECHANACPER date NOT NULL,
    CONSTRAINT PERSONA_pk PRIMARY KEY (IDPER)
) ;


CREATE TABLE CATEGORIA (
    IDCAT integer  NOT NULL,
    NOMCAT varchar2(50)  NOT NULL,
    CONSTRAINT CATEGORIA_pk PRIMARY KEY (IDCAT)
) ;


CREATE TABLE PRODUCTO (
    CODPRO char(3)  NOT NULL,
    NOMPRO varchar2(50)  NOT NULL,
    PREPRO integer  NOT NULL,
    STOCKPRO integer  NOT NULL,
    IDCATPRO integer  NOT NULL,
    ESTPRO char(1) Default 'A' NOT NULL,
    CONSTRAINT PRODUCTO_pk PRIMARY KEY (CODPRO)
) ;


CREATE TABLE VENTA (
    IDVEN integer  NOT NULL,
    FECVEN date NOT NULL ,
    IDVENDET integer  NOT NULL,
    IDCLI integer  NOT NULL,
    TIPPAGVEN char(1) NOT NULL,
    ESTVEN char(1) Default 'A' NOT NULL,
    CONSTRAINT VENTA_pk PRIMARY KEY (IDVEN)
) ;


CREATE TABLE VENTA_DETALLE (
    IDVENDET integer  NOT NULL,    
    IDVEN integer  NOT NULL,
    CODPRO char(3)  NOT NULL,
    CANVENDET integer  NOT NULL,
    CONSTRAINT VENTA_DETALLE_pk PRIMARY KEY (IDVENDET)
) ;


CREATE SEQUENCE INC_IDPER
START WITH 200
INCREMENT BY 1;


CREATE TRIGGER TRG_INC_PER
  BEFORE INSERT ON PERSONA 
  FOR EACH ROW
  BEGIN
    SELECT INC_IDPER.NEXTVAL INTO :NEW.IDPER FROM DUAL;
  END;


 INSERT ALL
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('77889955','Alberto','Solano Pariona','alberto.pariona@empresa.com','998456321','V','A','10/2/1970')
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('45781233','Alicia','García Campos','alicia.garcia@gmail.com','998456321','V','A','10/2/1970')
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('15487922','Juana','Avila Chumpitaz','juana.avila@gmail.com','998456321','V','A','10/2/1970')
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('22116633','Ana','Enriquez Flores','ana.enriquez@empresa.com','998456321','V','A','10/2/1970')
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('88741589','Claudia','Perales Ortiz','claudia.perales@yahoo.com','998456321','V','A','10/2/1970')
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('45122587','Mario','Barrios Martinez','mario.barrios@outlook.com','998456321','V','A','10/2/1970')
       INTO PERSONA (DNIPER,NOMPER,APEPER,EMAPER,CELPER,TIPPER,ESTPER,FECHANACPER)
       VALUES('15258564','Brunela','Tarazona Guerra','brunela.tarazona@gmail.com','998456321','V','A','10/2/1970')
       SELECT * FROM DUAL
COMMIT; 


CREATE SEQUENCE INC_IDCAT
START WITH 10
INCREMENT BY 10;
CREATE TRIGGER TRG_INC_CAT
  BEFORE INSERT ON CATEGORIA 
  FOR EACH ROW
  BEGIN
    SELECT INC_IDCAT.NEXTVAL INTO :NEW.IDCAT FROM DUAL;
  END;


 INSERT ALL
       INTO CATEGORIA (NOMCAT)
       VALUES('Abarrotes')
       INTO CATEGORIA (NOMCAT)
       VALUES('Carnes y Pollo')
       INTO CATEGORIA (NOMCAT)
       VALUES('Higiene y Limpieza')
       SELECT * FROM DUAL
COMMIT; 


ALTER TABLE PRODUCTO ADD CONSTRAINT PRODUCTO_CATEGORIA
    FOREIGN KEY (IDCATPRO)
    REFERENCES CATEGORIA (IDCAT);


 INSERT ALL
       INTO PRODUCTO (CODPRO,NOMPRO,PREPRO,STOCKPRO,IDCATPRO,ESTPRO)
       VALUES('P01','Arroz','4,65','50','10','A')
       INTO PRODUCTO (CODPRO,NOMPRO,PREPRO,STOCKPRO,IDCATPRO,ESTPRO)
       VALUES('P02','Azucar','3,45','60','10','A')
       INTO PRODUCTO (CODPRO,NOMPRO,PREPRO,STOCKPRO,IDCATPRO,ESTPRO)
       VALUES('P03','Pollo fresco','8,70','20','20','A')
       INTO PRODUCTO (CODPRO,NOMPRO,PREPRO,STOCKPRO,IDCATPRO,ESTPRO)
       VALUES('P04','Lomo fino','18,50','40','20','A')
       INTO PRODUCTO (CODPRO,NOMPRO,PREPRO,STOCKPRO,IDCATPRO,ESTPRO)
       VALUES('P05','Detergente Opal','8,75','60','30','A')
       INTO PRODUCTO (CODPRO,NOMPRO,PREPRO,STOCKPRO,IDCATPRO,ESTPRO)
       VALUES('P06','Suavitel Arien','7,85','30','30','A')
       SELECT * FROM DUAL
COMMIT; 


ALTER TABLE VENTA ADD CONSTRAINT VENTA_PERSONA
    FOREIGN KEY (IDCLI)
    REFERENCES PERSONA (IDPER);
   
   
ALTER TABLE VENTA_DETALLE ADD CONSTRAINT VENTA_DETALLE_VENTA
    FOREIGN KEY (IDVEN)
    REFERENCES VENTA (IDVEN);
   
   
ALTER TABLE VENTA_DETALLE ADD CONSTRAINT VENTA_DETALLE_PRODUCTO
    FOREIGN KEY (CODPRO)
    REFERENCES PRODUCTO (CODPRO);


CREATE SEQUENCE INC_IDVEN
START WITH 1
INCREMENT BY 1;


CREATE SEQUENCE INC_IDVENDET
START WITH 300
INCREMENT BY 1;

    
CREATE TRIGGER TRG_INC_VEN
  BEFORE INSERT ON VENTA 
  FOR EACH ROW
  BEGIN
    SELECT INC_IDVEN.NEXTVAL INTO :NEW.IDVEN FROM DUAL;
  END;


  CREATE TRIGGER TRG_INC_VENDET
  BEFORE INSERT ON VENTA_DETALLE 
  FOR EACH ROW
  BEGIN
    SELECT INC_IDVENDET.NEXTVAL INTO :NEW.IDVENDET FROM DUAL;
  END;


 INSERT ALL
       INTO VENTA (FECVEN,IDVENDET,IDCLI,TIPPAGVEN,ESTVEN)
       VALUES('25/10/2022','200','202','E','A')
       INTO VENTA (FECVEN,IDVENDET,IDCLI,TIPPAGVEN,ESTVEN)
       VALUES('25/10/2022','200','204','T','A')
       INTO VENTA (FECVEN,IDVENDET,IDCLI,TIPPAGVEN,ESTVEN)
       VALUES('25/10/2022','203','205','T','A')
       INTO VENTA (FECVEN,IDVENDET,IDCLI,TIPPAGVEN,ESTVEN)
       VALUES('25/10/2022','203','206','E','A')
       SELECT * FROM DUAL
COMMIT; 


INSERT ALL
       INTO VENTA_DETALLE (IDVEN,CODPRO,CANVENDET)
       VALUES('1','P01','2')
       INTO VENTA_DETALLE (IDVEN,CODPRO,CANVENDET)
       VALUES('1','P04','4')
       SELECT * FROM DUAL
COMMIT;

